<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using CohortIncidence • CohortIncidence</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using CohortIncidence">
<meta property="og:description" content="CohortIncidence">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CohortIncidence</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">4.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/using-cohortincidence.html">Using CohortIncidence</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/Hades" class="external-link">hadesLogo</a>
</li>
<li>
  <a href="https://github.com/OHDSI/CohortIncidence/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using CohortIncidence</h1>
                        <h4 data-toc-skip class="author">Christopher
Knoll</h4>
            
            <h4 data-toc-skip class="date">2024-07-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/CohortIncidence/blob/HEAD/vignettes/using-cohortincidence.Rmd" class="external-link"><code>vignettes/using-cohortincidence.Rmd</code></a></small>
      <div class="hidden name"><code>using-cohortincidence.Rmd</code></div>

    </div>

    
    
<pre><code><span><span class="co">#&gt; Loading required package: DatabaseConnector</span></span></code></pre>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette describes how to use the <code>CohortIncidence</code>
package to perform a single incidence rate analysis for a given target
and outcome cohort, with a few settings for Time At Risk and Clean
Window.</p>
</div>
<div class="section level2">
<h2 id="installation-instructions">Installation instructions<a class="anchor" aria-label="anchor" href="#installation-instructions"></a>
</h2>
<p>Before installing the <code>CohortIncidence</code> package make sure
you have Java available. Java can be downloaded from <a href="http://www.java.com" class="external-link">www.java.com</a>. For Windows users, RTools
is also necessary. RTools can be downloaded from <a href="http://cran.r-project.org/bin/windows/Rtools/" class="external-link">CRAN</a>.</p>
<p>The <code>CohortIncidence</code> package is currently maintained in a
<a href="https://github.com/OHDSI/CohortIncidence" class="external-link">Github
repository</a>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"ohdsi/CohortIncidence"</span><span class="op">)</span></span></code></pre></div>
<p>Once installed, you can type <code><a href="https://github.com/OHDSI/CohortIncidence" class="external-link">library(CohortIncidence)</a></code> to
load the package.</p>
</div>
<div class="section level2">
<h2 id="database-preparation">Database Preparation<a class="anchor" aria-label="anchor" href="#database-preparation"></a>
</h2>
<p>The results of the anlaysis SQL will assume a final table:
<code>@results_database_schema.incidence_summary</code>. The DDL for
this table can be fetched from the package via the following:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Fetch DDL from package</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>ddl <span class="ot">&lt;-</span> CohortIncidence<span class="sc">::</span><span class="fu">getResultsDdl</span>()</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">cat</span>(ddl)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>CREATE TABLE <span class="sc">@</span>schemaName.incidence_summary</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>(  </span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>    ref_id int,</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>    source_name <span class="fu">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>    target_cohort_definition_id bigint,</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>    tar_id bigint,</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>    subgroup_id bigint,</span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    outcome_id bigint,</span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>    age_group_id int,</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>    gender_id int,</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>    gender_name <span class="fu">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>    start_year int,</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>    persons_at_risk_pe bigint,</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>    persons_at_risk bigint,</span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>    person_days_pe bigint,</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>    person_days bigint,</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>    person_outcomes_pe bigint,</span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>    person_outcomes bigint,</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>    outcomes_pe bigint,</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>    outcomes bigint,</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>    incidence_proportion_p100p float,</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>    incidence_rate_p100py float</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a> );</span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>CREATE TABLE <span class="sc">@</span>schemaName.target_def</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>(  </span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>    ref_id int,</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>    target_cohort_definition_id bigint,</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>    target_name <span class="fu">varchar</span>(<span class="dv">255</span>)</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>);</span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a>CREATE TABLE <span class="sc">@</span>schemaName.outcome_def</span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>(  </span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>    ref_id int,</span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>    outcome_id bigint,</span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>    outcome_cohort_definition_id bigint,</span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>    outcome_name <span class="fu">varchar</span>(<span class="dv">255</span>),</span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>    clean_window bigint,</span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>    excluded_cohort_definition_id bigint</span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a>);</span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>CREATE TABLE <span class="sc">@</span>schemaName.tar_def</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>(</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>    ref_id int,</span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>    tar_id bigint,</span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>    tar_start_with <span class="fu">varchar</span>(<span class="dv">10</span>),</span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>    tar_start_offset bigint,</span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a>    tar_end_with <span class="fu">varchar</span>(<span class="dv">10</span>),</span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a>    tar_end_offset bigint</span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a></span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a>);</span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a>create table <span class="sc">@</span>schemaName.age_group_def</span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>(</span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>    ref_id int,</span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a>    age_group_id int NOT <span class="cn">NULL</span>,</span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a>    age_group_name <span class="fu">varchar</span>(<span class="dv">50</span>) NOT <span class="cn">NULL</span>,</span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>    min_age int <span class="cn">NULL</span>,</span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>    max_age int <span class="cn">NULL</span></span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a></span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a>);</span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a>CREATE TABLE <span class="sc">@</span>schemaName.subgroup_def</span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a>(</span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a>    ref_id int,</span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a>    subgroup_id bigint,</span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>    subgroup_name <span class="fu">varchar</span>(<span class="dv">255</span>)</span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a>);</span></code></pre></div>
<p>Using <code>SqlRender</code> and <code>DatabaseConnector</code>, you
can execute the above on your target database platform in order to
deploy the table. Remember to replace <code>@schemaName</code> with the
appropriate schema. You can also ‘hack’ the <code>@schemaName</code>
paramater to apply a prefix by specifying the SqlRender paramater of
<code>schemaName.incidence_summary</code> to a target table ie:
<code>mySchema.prefix_incidence_summary</code>. Using the same paramater
name/value in <code><a href="../reference/buildQuery.html">buildQuery()</a></code> will allow you to provide a
prefix to the result table name instead of having to declare a separate
schema.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">connectionDetails</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/createConnectionDetails.html" class="external-link">createConnectionDetails</a></span><span class="op">(</span>dbms <span class="op">=</span> <span class="st">"postgresql"</span>,server<span class="op">=</span><span class="op">{</span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"server"</span><span class="op">)</span><span class="op">}</span>, port <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"port"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># to specify the target schema (the typical use case):</span></span>
<span><span class="va">ddl</span> <span class="op">&lt;-</span> <span class="fu">SqlRender</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/render.html" class="external-link">render</a></span><span class="op">(</span><span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/getResultsDdl.html">getResultsDdl</a></span><span class="op">(</span><span class="op">)</span>, schemaName <span class="op">=</span> <span class="st">"mySchema"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># a work-around to provide a prefix to the result table, in case creating new schema is restricted</span></span>
<span><span class="va">ddlPrefix</span> <span class="op">&lt;-</span> <span class="fu">SqlRender</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/render.html" class="external-link">render</a></span><span class="op">(</span><span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/getResultsDdl.html">getResultsDdl</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"schemaName.incidence_summary"</span> <span class="op">=</span> <span class="st">"mySchema.prefix_incidence_summary"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">con</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span></span>
<span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/executeSql.html" class="external-link">executeSql</a></span><span class="op">(</span><span class="va">ddl</span><span class="op">)</span></span>
<span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/disconnect.html" class="external-link">disconnect</a></span><span class="op">(</span><span class="va">con</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="a-simple-example">A simple example<a class="anchor" aria-label="anchor" href="#a-simple-example"></a>
</h2>
<p>This example will create a CohortIncidence design containing a single
target, outcome, and time at risk.</p>
<div class="section level3">
<h3 id="build-the-design">Build the design<a class="anchor" aria-label="anchor" href="#build-the-design"></a>
</h3>
<p>The following script builds a single T, O and Time at Risk, and
assembles those element into a design. Finally, the resulting JSON is
printed.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">t1</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/createCohortRef.html">createCohortRef</a></span><span class="op">(</span>id<span class="op">=</span><span class="fl">1</span>, name<span class="op">=</span><span class="st">"Target cohort 1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">o1</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/createOutcomeDef.html">createOutcomeDef</a></span><span class="op">(</span>id<span class="op">=</span><span class="fl">1</span>,name<span class="op">=</span><span class="st">"Outcome 1, 30d Clean"</span>, </span>
<span>                                               cohortId <span class="op">=</span><span class="fl">2</span>,</span>
<span>                                               cleanWindow <span class="op">=</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tar1</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/createTimeAtRiskDef.html">createTimeAtRiskDef</a></span><span class="op">(</span>id<span class="op">=</span><span class="fl">1</span>, </span>
<span>                                             startWith<span class="op">=</span><span class="st">"start"</span>, </span>
<span>                                             endWith<span class="op">=</span><span class="st">"end"</span>, </span>
<span>                                             endOffset<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Note: c() is used when dealing with an array of numbers, </span></span>
<span><span class="co"># later we use list() when dealing with an array of objects</span></span>
<span><span class="va">analysis1</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/createIncidenceAnalysis.html">createIncidenceAnalysis</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">t1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>,</span>
<span>                                                      outcomes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">o1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>,</span>
<span>                                                      tars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tar1</span><span class="op">$</span><span class="va">id</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">subgroup1</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/createCohortSubgroup.html">createCohortSubgroup</a></span><span class="op">(</span>id<span class="op">=</span><span class="fl">1</span>, name<span class="op">=</span><span class="st">"Subgroup 1"</span>, cohortRef <span class="op">=</span> <span class="fu"><a href="../reference/createCohortRef.html">createCohortRef</a></span><span class="op">(</span>id<span class="op">=</span><span class="fl">300</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Create Design (note use of list() here):</span></span>
<span><span class="va">irDesign</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/createIncidenceDesign.html">createIncidenceDesign</a></span><span class="op">(</span>targetDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">t1</span><span class="op">)</span>,</span>
<span>                                                   outcomeDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">o1</span><span class="op">)</span>,</span>
<span>                                                   tars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">tar1</span><span class="op">)</span>,</span>
<span>                                                   analysisList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">analysis1</span><span class="op">)</span>,</span>
<span>                                                   subgroups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">subgroup1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># Render the design as JSON</span></span>
<span><span class="va">irDesign</span><span class="op">$</span><span class="fu">asJSON</span><span class="op">(</span>pretty <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span><span class="co">#&gt; {</span></span>
<span><span class="co">#&gt;   "targetDefs": [</span></span>
<span><span class="co">#&gt;     {</span></span>
<span><span class="co">#&gt;       "id": 1,</span></span>
<span><span class="co">#&gt;       "name": "Target cohort 1"</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   ],</span></span>
<span><span class="co">#&gt;   "outcomeDefs": [</span></span>
<span><span class="co">#&gt;     {</span></span>
<span><span class="co">#&gt;       "id": 1,</span></span>
<span><span class="co">#&gt;       "name": "Outcome 1, 30d Clean",</span></span>
<span><span class="co">#&gt;       "cohortId": 2,</span></span>
<span><span class="co">#&gt;       "cleanWindow": 30</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   ],</span></span>
<span><span class="co">#&gt;   "timeAtRiskDefs": [</span></span>
<span><span class="co">#&gt;     {</span></span>
<span><span class="co">#&gt;       "id": 1,</span></span>
<span><span class="co">#&gt;       "start": {</span></span>
<span><span class="co">#&gt;         "dateField": "start",</span></span>
<span><span class="co">#&gt;         "offset": 0</span></span>
<span><span class="co">#&gt;       },</span></span>
<span><span class="co">#&gt;       "end": {</span></span>
<span><span class="co">#&gt;         "dateField": "end",</span></span>
<span><span class="co">#&gt;         "offset": 30</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   ],</span></span>
<span><span class="co">#&gt;   "analysisList": [</span></span>
<span><span class="co">#&gt;     {</span></span>
<span><span class="co">#&gt;       "targets": [1],</span></span>
<span><span class="co">#&gt;       "outcomes": [1],</span></span>
<span><span class="co">#&gt;       "tars": [1]</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   ],</span></span>
<span><span class="co">#&gt;   "subgroups": [</span></span>
<span><span class="co">#&gt;     {</span></span>
<span><span class="co">#&gt;       "CohortSubgroup": {</span></span>
<span><span class="co">#&gt;         "id": 1,</span></span>
<span><span class="co">#&gt;         "name": "Subgroup 1",</span></span>
<span><span class="co">#&gt;         "cohort": {</span></span>
<span><span class="co">#&gt;           "id": 300</span></span>
<span><span class="co">#&gt;         }</span></span>
<span><span class="co">#&gt;       }</span></span>
<span><span class="co">#&gt;     }</span></span>
<span><span class="co">#&gt;   ]</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-age-gender-and-start-year-strata">Using age, gender and start year strata<a class="anchor" aria-label="anchor" href="#using-age-gender-and-start-year-strata"></a>
</h3>
<p>The IR design can also include settings to specify if an analysis
should be done at the age, gender or start year levels (or any
combination of those choices). To use this function, you create the
strata settings with the
<code>CohortIncidence::createStrataSettings)</code> function:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">irDesignWithStrata</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/createIncidenceDesign.html">createIncidenceDesign</a></span><span class="op">(</span></span>
<span>    targetDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">t1</span><span class="op">)</span>,</span>
<span>    outcomeDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">o1</span><span class="op">)</span>,</span>
<span>    tars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">tar1</span><span class="op">)</span>,</span>
<span>    analysisList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">analysis1</span><span class="op">)</span>,</span>
<span>    subgroups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">subgroup1</span><span class="op">)</span>,</span>
<span>    <span class="co">#add by age and by gender strata, but don't do by start year.</span></span>
<span>    strataSettings <span class="op">=</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/createStrataSettings.html">createStrataSettings</a></span><span class="op">(</span></span>
<span>      byGender <span class="op">=</span> <span class="cn">T</span>,</span>
<span>      byAge <span class="op">=</span> <span class="cn">T</span>,</span>
<span>      ageBreaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">17</span>, <span class="fl">34</span>, <span class="fl">65</span><span class="op">)</span>,</span>
<span>      ageBreakList <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">25</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">65</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>In the above example, thare are 2 ways of specifying the age breaks:
ageBreaks and ageBreakList. ageBreaks creates a single age break
specification, while ageBreakList allows you to specify a list of
breaks. All breaks defined in ageBreaks and ageBreakList will be used if
specified. If byAge is TRUE, you must specify at least one age break
specification either in ageBreaks or ageBreakList.</p>
</div>
<div class="section level3">
<h3 id="using-executeanalysis">Using executeAnalysis()<a class="anchor" aria-label="anchor" href="#using-executeanalysis"></a>
</h3>
<p>If there is no need to see the analysis sql or control the output of
the analysis to a permenant table, the <code><a href="../reference/executeAnalysis.html">executeAnalysis()</a></code>
function can be used to perform the cohort incidence using a simple
API:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">buildOptions</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/buildOptions.html">buildOptions</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"demoCohortSchema.cohort"</span>,</span>
<span>                                              cdmDatabaseSchema <span class="op">=</span> <span class="st">"mycdm"</span>,</span>
<span>                                              sourceName <span class="op">=</span> <span class="st">"mysource"</span>,</span>
<span>                                              refId <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">executeResults</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/executeAnalysis.html">executeAnalysis</a></span><span class="op">(</span>connectionDetails <span class="op">=</span> <span class="va">connectionDetails</span>,</span>
<span>                                                   incidenceDesign <span class="op">=</span> <span class="va">irDesign</span>,</span>
<span>                                                   buildOptions <span class="op">=</span> <span class="va">buildOptions</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/executeAnalysis.html">executeAnalysis()</a></code> will return a list of dataframes with
the following fields: - incidenceSummary - targetDef - outcomeDef -
tarDef - ageGroupDef - subgroupDef</p>
<p>These dataframes follow the same structure as the corresponding
tables described in the Database Preparation section.</p>
</div>
</div>
<div class="section level2">
<h2 id="advanced-usage-budling-and-executing-sql-manually">Advanced Usage: Budling and Executing SQL manually<a class="anchor" aria-label="anchor" href="#advanced-usage-budling-and-executing-sql-manually"></a>
</h2>
<p>There may be a reason (debugging or special processing steps) Where
you would want to access the analysis SQL before execution.<br>
The following sections describe how to fetch the SQL, translate and
execute the statements.</p>
<div class="section level3">
<h3 id="build-analysis-sql-from-design">Build analysis SQL from design<a class="anchor" aria-label="anchor" href="#build-analysis-sql-from-design"></a>
</h3>
<p>From the previous design, the
<code><a href="../reference/buildQuery.html">CohortIncidence::buildQuery()</a></code> method is used to generate
the analysis SQL:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">buildOptions</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/buildOptions.html">buildOptions</a></span><span class="op">(</span>cohortTable <span class="op">=</span> <span class="st">"demoCohortSchema.cohort"</span>,</span>
<span>                                              cdmDatabaseSchema <span class="op">=</span> <span class="st">"mycdm"</span>,</span>
<span>                                              resultsDatabaseSchema <span class="op">=</span> <span class="st">"myresults"</span>,</span>
<span>                                              sourceName <span class="op">=</span> <span class="st">"mysource"</span>,</span>
<span>                                              refId <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">analysisSql</span> <span class="op">&lt;-</span> <span class="fu">CohortIncidence</span><span class="fu">::</span><span class="fu"><a href="../reference/buildQuery.html">buildQuery</a></span><span class="op">(</span>incidenceDesign <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">irDesign</span><span class="op">$</span><span class="fu">asJSON</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                           buildOptions <span class="op">=</span> <span class="va">buildOptions</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">analysisSql</span><span class="op">)</span></span>
<span><span class="co">#&gt; INSERT INTO myresults.target_def (ref_id, target_cohort_definition_id, target_name)</span></span>
<span><span class="co">#&gt; select CAST(1 as int) as ref_id, target_cohort_definition_id, target_name</span></span>
<span><span class="co">#&gt; from (</span></span>
<span><span class="co">#&gt; select cast(1 as int) as target_cohort_definition_id, </span></span>
<span><span class="co">#&gt;  cast ('Target cohort 1' as varchar(255)) as target_name</span></span>
<span><span class="co">#&gt; ) T</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; INSERT INTO myresults.tar_def (ref_id, tar_id, tar_start_with, tar_start_offset, tar_end_with, tar_end_offset)</span></span>
<span><span class="co">#&gt; select CAST(1 as int) as ref_id, tar_id, tar_start_with, tar_start_offset, tar_end_with, tar_end_offset</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt; select cast(1 as int) as tar_id, </span></span>
<span><span class="co">#&gt;  cast ('start' as varchar(10)) as tar_start_with, cast (0 as int) as tar_start_offset,</span></span>
<span><span class="co">#&gt;  cast ('end' as varchar(10)) as tar_end_with, cast (30 as int) as tar_end_offset</span></span>
<span><span class="co">#&gt; ) T</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; INSERT INTO myresults.outcome_def (ref_id, outcome_id, outcome_cohort_definition_id, outcome_name, clean_window, excluded_cohort_definition_id)</span></span>
<span><span class="co">#&gt; select CAST(1 as int) as ref_id, outcome_id, outcome_cohort_definition_id, outcome_name, clean_window, excluded_cohort_definition_id</span></span>
<span><span class="co">#&gt; from (</span></span>
<span><span class="co">#&gt; select cast(1 as int) as outcome_id, cast(2 as int) as outcome_cohort_definition_id,</span></span>
<span><span class="co">#&gt;  cast ('Outcome 1, 30d Clean' as varchar(255)) as outcome_name,</span></span>
<span><span class="co">#&gt;  cast (30 as int) as clean_window,</span></span>
<span><span class="co">#&gt;  cast (0 as int) as excluded_cohort_definition_id</span></span>
<span><span class="co">#&gt; ) O</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; INSERT INTO myresults.subgroup_def (ref_id, subgroup_id, subgroup_name)</span></span>
<span><span class="co">#&gt; select CAST(1 as int) as ref_id, subgroup_id, subgroup_name</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt; select cast(0 as int) as subgroup_id, </span></span>
<span><span class="co">#&gt;  cast ('All' as varchar(250)) as subgroup_name</span></span>
<span><span class="co">#&gt; UNION ALL</span></span>
<span><span class="co">#&gt; select cast(1 as int) as subgroup_id, </span></span>
<span><span class="co">#&gt;  cast ('Subgroup 1' as varchar(250)) as subgroup_name</span></span>
<span><span class="co">#&gt; ) S</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --</span></span>
<span><span class="co">#&gt; -- Begin analysis 0</span></span>
<span><span class="co">#&gt; --</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; /****************************************</span></span>
<span><span class="co">#&gt; code to implement calculation using the inputs above, no need to modify beyond this point</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 1) create T + TAR periods</span></span>
<span><span class="co">#&gt; 2) create table to store era-fied excluded at-risk periods</span></span>
<span><span class="co">#&gt; 3) calculate pre-exclude outcomes and outcomes </span></span>
<span><span class="co">#&gt; 4) calculate exclsion time per T/O/TAR/Subject/start_date</span></span>
<span><span class="co">#&gt; 5) generate raw result table with T/O/TAR/subject_id, start_date, pe_at_risk (datediff(d,start,end), at_risk (pe_at_risk - exclusion time), pe_outcomes, outcomes</span></span>
<span><span class="co">#&gt;    attach age/gender/year columns</span></span>
<span><span class="co">#&gt; 6) Create analysis_ref to produce each T/O/TAR combo</span></span>
<span><span class="co">#&gt; 7) perform rollup to calculate IR at the T/O/TAR/S/[age|gender|year] inclusing distinct people and distinct cases for 'all' and each subgroup</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; **************************************/</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- 1) create T + TAR periods</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --HINT DISTRIBUTE_ON_KEY(subject_id)</span></span>
<span><span class="co">#&gt; select subject_id, cohort_definition_id, tar_id, cast(0 as int) as subgroup_id, start_date, end_date </span></span>
<span><span class="co">#&gt; into #TTAR_erafied_all</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   select subject_id, cohort_definition_id, tar_id, min(start_date) as start_date, max(end_date) as end_date</span></span>
<span><span class="co">#&gt;   from (</span></span>
<span><span class="co">#&gt;     select subject_id, cohort_definition_id, tar_id, start_date, end_date, sum(is_start) over (partition by subject_id, cohort_definition_id, tar_id order by start_date, is_start desc rows unbounded preceding) group_idx</span></span>
<span><span class="co">#&gt;     from (</span></span>
<span><span class="co">#&gt;       select subject_id, cohort_definition_id, tar_id, start_date, end_date, </span></span>
<span><span class="co">#&gt;         case when max(end_date) over (partition by subject_id, cohort_definition_id, tar_id order by start_date rows between unbounded preceding and 1 preceding) &gt;= start_date then 0 else 1 end is_start</span></span>
<span><span class="co">#&gt;       from (</span></span>
<span><span class="co">#&gt;         SELECT subject_id, cohort_definition_id, tar_id, start_date, end_date</span></span>
<span><span class="co">#&gt;         FROM</span></span>
<span><span class="co">#&gt;         (</span></span>
<span><span class="co">#&gt;           select tc1.cohort_definition_id,</span></span>
<span><span class="co">#&gt;             tar1.tar_id,</span></span>
<span><span class="co">#&gt;             subject_id,</span></span>
<span><span class="co">#&gt;             case </span></span>
<span><span class="co">#&gt;               when tar1.tar_start_with = 'start' then</span></span>
<span><span class="co">#&gt;                 case when DATEADD(day,CAST(tar1.tar_start_offset as int),tc1.cohort_start_date) &lt; op1.observation_period_end_date then DATEADD(day,CAST(tar1.tar_start_offset as int),tc1.cohort_start_date)</span></span>
<span><span class="co">#&gt;                   when DATEADD(day,CAST(tar1.tar_start_offset as int),tc1.cohort_start_date) &gt;= op1.observation_period_end_date then op1.observation_period_end_date</span></span>
<span><span class="co">#&gt;                 end</span></span>
<span><span class="co">#&gt;               when tar1.tar_start_with = 'end' then</span></span>
<span><span class="co">#&gt;                 case when DATEADD(day,CAST(tar1.tar_start_offset as int),tc1.cohort_end_date) &lt; op1.observation_period_end_date then DATEADD(day,CAST(tar1.tar_start_offset as int),tc1.cohort_end_date)</span></span>
<span><span class="co">#&gt;                   when DATEADD(day,CAST(tar1.tar_start_offset as int),tc1.cohort_end_date) &gt;= op1.observation_period_end_date then op1.observation_period_end_date</span></span>
<span><span class="co">#&gt;                 end</span></span>
<span><span class="co">#&gt;               else null --shouldnt get here if tar set properly</span></span>
<span><span class="co">#&gt;             end as start_date,</span></span>
<span><span class="co">#&gt;             case </span></span>
<span><span class="co">#&gt;               when tar1.tar_end_with = 'start' then</span></span>
<span><span class="co">#&gt;                 case when DATEADD(day,CAST(tar1.tar_end_offset as int),tc1.cohort_start_date) &lt; op1.observation_period_end_date then DATEADD(day,CAST(tar1.tar_end_offset as int),tc1.cohort_start_date)</span></span>
<span><span class="co">#&gt;                   when DATEADD(day,CAST(tar1.tar_end_offset as int),tc1.cohort_start_date) &gt;= op1.observation_period_end_date then op1.observation_period_end_date</span></span>
<span><span class="co">#&gt;                 end</span></span>
<span><span class="co">#&gt;               when tar1.tar_end_with = 'end' then</span></span>
<span><span class="co">#&gt;                 case when DATEADD(day,CAST(tar1.tar_end_offset as int),tc1.cohort_end_date) &lt; op1.observation_period_end_date then DATEADD(day,CAST(tar1.tar_end_offset as int),tc1.cohort_end_date)</span></span>
<span><span class="co">#&gt;                   when DATEADD(day,CAST(tar1.tar_end_offset as int),tc1.cohort_end_date) &gt;= op1.observation_period_end_date then op1.observation_period_end_date</span></span>
<span><span class="co">#&gt;                 end</span></span>
<span><span class="co">#&gt;               else null --shouldnt get here if tar set properly</span></span>
<span><span class="co">#&gt;             end as end_date</span></span>
<span><span class="co">#&gt;           from (</span></span>
<span><span class="co">#&gt;             select tar_id, tar_start_with, tar_start_offset, tar_end_with, tar_end_offset  </span></span>
<span><span class="co">#&gt;             from myresults.tar_def where tar_id in (1) and ref_id = 1</span></span>
<span><span class="co">#&gt;           ) tar1,</span></span>
<span><span class="co">#&gt;           (</span></span>
<span><span class="co">#&gt;             select cohort_definition_id, subject_id, cohort_start_date, cohort_end_date </span></span>
<span><span class="co">#&gt;             from demoCohortSchema.cohort </span></span>
<span><span class="co">#&gt;             where cohort_definition_id in (1)</span></span>
<span><span class="co">#&gt;           ) tc1</span></span>
<span><span class="co">#&gt;           inner join mycdm.observation_period op1 on tc1.subject_id = op1.person_id</span></span>
<span><span class="co">#&gt;             and tc1.cohort_start_date &gt;= op1.observation_period_start_date</span></span>
<span><span class="co">#&gt;             and tc1.cohort_start_date &lt;= op1.observation_period_end_date</span></span>
<span><span class="co">#&gt;         ) COHORT_TAR</span></span>
<span><span class="co">#&gt;         WHERE COHORT_TAR.start_date &lt;= COHORT_TAR.end_date</span></span>
<span><span class="co">#&gt;       ) TAR</span></span>
<span><span class="co">#&gt;     ) ST</span></span>
<span><span class="co">#&gt;   ) GR</span></span>
<span><span class="co">#&gt;   GROUP BY subject_id, cohort_definition_id, tar_id, group_idx</span></span>
<span><span class="co">#&gt; ) T</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; create table #subgroup_person</span></span>
<span><span class="co">#&gt; (</span></span>
<span><span class="co">#&gt;   subgroup_id bigint NOT NULL,</span></span>
<span><span class="co">#&gt;   subject_id bigint NOT NULL,</span></span>
<span><span class="co">#&gt;   start_date date NOT NULL</span></span>
<span><span class="co">#&gt; );</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; INSERT INTO #subgroup_person (subgroup_id, subject_id, start_date)</span></span>
<span><span class="co">#&gt; select distinct cast(1 as int) as subgroup_id, t1.subject_id, t1.start_date</span></span>
<span><span class="co">#&gt; FROM #TTAR_erafied_all t1</span></span>
<span><span class="co">#&gt; JOIN demoCohortSchema.cohort s1 on t1.subject_id = s1.subject_id</span></span>
<span><span class="co">#&gt;   and t1.start_date  &gt;= s1.cohort_start_date</span></span>
<span><span class="co">#&gt;   and t1.start_date &lt;= s1.cohort_end_date</span></span>
<span><span class="co">#&gt; WHERE s1.cohort_definition_id = 300</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --HINT DISTRIBUTE_ON_KEY(subject_id)</span></span>
<span><span class="co">#&gt; select tea.subject_id, tea.cohort_definition_id, tea.tar_id, s.subgroup_id, tea.start_date, tea.end_date </span></span>
<span><span class="co">#&gt; into #TTAR_erafied_sg</span></span>
<span><span class="co">#&gt; FROM #TTAR_erafied_all tea</span></span>
<span><span class="co">#&gt; JOIN #subgroup_person s on tea.subject_id = s.subject_id and tea.start_date = s.start_date</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --HINT DISTRIBUTE_ON_KEY(subject_id)</span></span>
<span><span class="co">#&gt; SELECT subject_id, cohort_definition_id, tar_id, subgroup_id, start_date, end_date</span></span>
<span><span class="co">#&gt; INTO #TTAR_erafied</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT subject_id, cohort_definition_id, tar_id, subgroup_id, start_date, end_date</span></span>
<span><span class="co">#&gt;   FROM #TTAR_erafied_all</span></span>
<span><span class="co">#&gt;   UNION ALL</span></span>
<span><span class="co">#&gt;   SELECT subject_id, cohort_definition_id, tar_id, subgroup_id, start_date, end_date</span></span>
<span><span class="co">#&gt;   FROM #TTAR_erafied_sg</span></span>
<span><span class="co">#&gt; ) TE;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; DROP TABLE #TTAR_erafied_all;</span></span>
<span><span class="co">#&gt; DROP TABLE #TTAR_erafied_sg;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; /*</span></span>
<span><span class="co">#&gt; 2) create table to store era-fied excluded at-risk periods</span></span>
<span><span class="co">#&gt; */</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --three ways for entry into excluded</span></span>
<span><span class="co">#&gt; --1:  duration of outcome periods  (ex:  immortal time due to clean period)</span></span>
<span><span class="co">#&gt; --2:  other periods excluded  (ex: persons post-appendectomy for appendicitis)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --HINT DISTRIBUTE_ON_KEY(subject_id)</span></span>
<span><span class="co">#&gt; select subject_id, outcome_id, min(start_date) as start_date, max(end_date) as end_date </span></span>
<span><span class="co">#&gt; into  #excluded_tar_cohort</span></span>
<span><span class="co">#&gt; from (</span></span>
<span><span class="co">#&gt;   select subject_id, outcome_id, start_date, end_date, sum(is_start) over (partition by subject_id, outcome_id order by start_date, is_start desc rows unbounded preceding) group_idx</span></span>
<span><span class="co">#&gt;   from (</span></span>
<span><span class="co">#&gt;     select subject_id, outcome_id, start_date, end_date, </span></span>
<span><span class="co">#&gt;       case when max(end_date) over (partition by subject_id, outcome_id order by start_date rows between unbounded preceding and 1 preceding) &gt;= start_date then 0 else 1 end is_start</span></span>
<span><span class="co">#&gt;     from (</span></span>
<span><span class="co">#&gt;       -- find excluded time from outcome cohorts and exclusion cohorts</span></span>
<span><span class="co">#&gt;       -- note, clean window added to event end date</span></span>
<span><span class="co">#&gt;       select oc1.subject_id, or1.outcome_id, dateadd(dd,1,oc1.cohort_start_date) as start_date, dateadd(dd,or1.clean_window, oc1.cohort_end_date) as end_date</span></span>
<span><span class="co">#&gt;       from demoCohortSchema.cohort oc1</span></span>
<span><span class="co">#&gt;       inner join (</span></span>
<span><span class="co">#&gt;         select outcome_id, outcome_cohort_definition_id, clean_window</span></span>
<span><span class="co">#&gt;         from myresults.outcome_def </span></span>
<span><span class="co">#&gt;         where outcome_id in (1) and ref_id = 1</span></span>
<span><span class="co">#&gt;       ) or1 on oc1.cohort_definition_id = or1.outcome_cohort_definition_id</span></span>
<span><span class="co">#&gt;       where dateadd(dd,or1.clean_window, oc1.cohort_end_date) &gt;= dateadd(dd,1,oc1.cohort_start_date)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;       union all</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;       SELECT c1.subject_id, or1.outcome_id, c1.cohort_start_date as start_date, c1.cohort_end_date as end_date</span></span>
<span><span class="co">#&gt;       FROM demoCohortSchema.cohort c1</span></span>
<span><span class="co">#&gt;       inner join (</span></span>
<span><span class="co">#&gt;         select outcome_id, excluded_cohort_definition_id </span></span>
<span><span class="co">#&gt;         from myresults.outcome_def </span></span>
<span><span class="co">#&gt;         where outcome_id in (1) and ref_id = 1</span></span>
<span><span class="co">#&gt;       ) or1 on c1.cohort_definition_id = or1.excluded_cohort_definition_id</span></span>
<span><span class="co">#&gt;     ) EXCLUDED</span></span>
<span><span class="co">#&gt;   ) ST</span></span>
<span><span class="co">#&gt; ) GR</span></span>
<span><span class="co">#&gt; GROUP BY subject_id, outcome_id, group_idx;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --HINT DISTRIBUTE_ON_KEY(subject_id)</span></span>
<span><span class="co">#&gt; select  ec1.subject_id,</span></span>
<span><span class="co">#&gt;   te1.cohort_definition_id as target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;   te1.tar_id,</span></span>
<span><span class="co">#&gt;   te1.subgroup_id,</span></span>
<span><span class="co">#&gt;   ec1.outcome_id,</span></span>
<span><span class="co">#&gt;   case when ec1.start_date &gt; te1.start_date then ec1.start_date else te1.start_date end as start_date,</span></span>
<span><span class="co">#&gt;   case when ec1.end_date &lt; te1.end_date then ec1.end_date else te1.end_date end as end_date</span></span>
<span><span class="co">#&gt; into #exc_TTAR_o_erafied</span></span>
<span><span class="co">#&gt; from #TTAR_erafied te1</span></span>
<span><span class="co">#&gt; inner join #excluded_tar_cohort ec1 on te1.subject_id = ec1.subject_id</span></span>
<span><span class="co">#&gt;   and ec1.start_date &lt;= te1.end_date</span></span>
<span><span class="co">#&gt;   and ec1.end_date &gt;= te1.start_date</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- 3) calculate pre-exclude outcomes and outcomes </span></span>
<span><span class="co">#&gt; -- calculate pe_outcomes and outcomes by T, TAR, O, Subject, TAR start</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --HINT DISTRIBUTE_ON_KEY(subject_id)</span></span>
<span><span class="co">#&gt; select t1.cohort_definition_id as target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;   t1.tar_id,</span></span>
<span><span class="co">#&gt;   t1.subgroup_id,</span></span>
<span><span class="co">#&gt;   t1.subject_id,</span></span>
<span><span class="co">#&gt;   t1.start_date,</span></span>
<span><span class="co">#&gt;   o1.outcome_id,</span></span>
<span><span class="co">#&gt;   count_big(o1.subject_id) as outcomes_pe,</span></span>
<span><span class="co">#&gt;   SUM(case when eo.tar_id is null then 1 else 0 end) as outcomes</span></span>
<span><span class="co">#&gt; into #outcome_smry</span></span>
<span><span class="co">#&gt; from #TTAR_erafied t1</span></span>
<span><span class="co">#&gt; inner join (</span></span>
<span><span class="co">#&gt;   select oref.outcome_id, oc.subject_id, oc.cohort_start_date</span></span>
<span><span class="co">#&gt;   from demoCohortSchema.cohort oc </span></span>
<span><span class="co">#&gt;   JOIN myresults.outcome_def oref on oc.cohort_definition_id = oref.outcome_cohort_definition_id</span></span>
<span><span class="co">#&gt;     and oref.ref_id = 1</span></span>
<span><span class="co">#&gt;   where oref.outcome_id in (1)</span></span>
<span><span class="co">#&gt; ) o1 on t1.subject_id = o1.subject_id</span></span>
<span><span class="co">#&gt;   and t1.start_date &lt;= o1.cohort_start_date</span></span>
<span><span class="co">#&gt;   and t1.end_date &gt;= o1.cohort_start_date</span></span>
<span><span class="co">#&gt; left join #exc_TTAR_o_erafied eo on t1.cohort_definition_id = eo.target_cohort_definition_id</span></span>
<span><span class="co">#&gt;   and t1.tar_id = eo.tar_id</span></span>
<span><span class="co">#&gt;   and t1.subgroup_id = eo.subgroup_id</span></span>
<span><span class="co">#&gt;   and o1.outcome_id = eo.outcome_id</span></span>
<span><span class="co">#&gt;   and o1.subject_id = eo.subject_id</span></span>
<span><span class="co">#&gt;   and eo.start_date &lt;= o1.cohort_start_date</span></span>
<span><span class="co">#&gt;   and eo.end_date &gt;= o1.cohort_start_date</span></span>
<span><span class="co">#&gt; group by t1.cohort_definition_id, t1.tar_id, t1.subgroup_id, t1.subject_id, t1.start_date, o1.outcome_id</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- 4) calculate exclsion time per T/O/TAR/Subject/start_date</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --HINT DISTRIBUTE_ON_KEY(subject_id)</span></span>
<span><span class="co">#&gt; SELECT EX.target_cohort_definition_id, EX.tar_id, EX.subgroup_id, EX.subject_id, EX.start_date, EX.outcome_id, EX.person_days</span></span>
<span><span class="co">#&gt; INTO #excluded_person_days</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;   SELECT t1.cohort_definition_id as target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;     t1.tar_id,</span></span>
<span><span class="co">#&gt;     t1.subgroup_id,</span></span>
<span><span class="co">#&gt;     t1.subject_id,</span></span>
<span><span class="co">#&gt;     t1.start_date,</span></span>
<span><span class="co">#&gt;     et1.outcome_id,</span></span>
<span><span class="co">#&gt;     sum(cast((DATEDIFF(day,et1.start_date,et1.end_date) + 1) as bigint)) as person_days</span></span>
<span><span class="co">#&gt;   FROM #TTAR_erafied t1</span></span>
<span><span class="co">#&gt;   inner join #exc_TTAR_o_erafied et1 on t1.cohort_definition_id = et1.target_cohort_definition_id</span></span>
<span><span class="co">#&gt;     and t1.subgroup_id = et1.subgroup_id</span></span>
<span><span class="co">#&gt;     and t1.tar_id = et1.tar_id</span></span>
<span><span class="co">#&gt;     and t1.subject_id = et1.subject_id</span></span>
<span><span class="co">#&gt;     and t1.start_date &lt;= et1.start_date</span></span>
<span><span class="co">#&gt;     and t1.end_date &gt;= et1.end_date</span></span>
<span><span class="co">#&gt;   group by t1.cohort_definition_id,</span></span>
<span><span class="co">#&gt;     t1.subgroup_id,</span></span>
<span><span class="co">#&gt;     t1.tar_id,</span></span>
<span><span class="co">#&gt;     t1.subject_id,</span></span>
<span><span class="co">#&gt;     t1.start_date,</span></span>
<span><span class="co">#&gt;     et1.outcome_id</span></span>
<span><span class="co">#&gt;  ) EX;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; /*</span></span>
<span><span class="co">#&gt; 5) aggregate tar and excluded+outcome</span></span>
<span><span class="co">#&gt; */</span></span>
<span><span class="co">#&gt; WITH tar_overall (target_cohort_definition_id, tar_id, subgroup_id, subject_id, start_date, end_date, age, gender_id, start_year)</span></span>
<span><span class="co">#&gt; AS (</span></span>
<span><span class="co">#&gt;   SELECT te.cohort_definition_id as target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;     te.tar_id,</span></span>
<span><span class="co">#&gt;     te.subgroup_id,</span></span>
<span><span class="co">#&gt;     te.subject_id,</span></span>
<span><span class="co">#&gt;     te.start_date,</span></span>
<span><span class="co">#&gt;     te.end_date,</span></span>
<span><span class="co">#&gt;     YEAR(te.start_date) - p.year_of_birth as age,</span></span>
<span><span class="co">#&gt;     p.gender_concept_id as gender_id,</span></span>
<span><span class="co">#&gt;     YEAR(te.start_date) as start_year</span></span>
<span><span class="co">#&gt;   FROM #TTAR_erafied te</span></span>
<span><span class="co">#&gt;   JOIN mycdm.person p on te.subject_id = p.person_id</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; select target_cohort_definition_id, tar_id, subgroup_id, age_group_id, gender_id, start_year, person_days_pe, persons_at_risk_pe</span></span>
<span><span class="co">#&gt; INTO #tar_agg</span></span>
<span><span class="co">#&gt; FROM (</span></span>
<span><span class="co">#&gt;     SELECT t1.target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;     t1.tar_id,</span></span>
<span><span class="co">#&gt;     t1.subgroup_id,</span></span>
<span><span class="co">#&gt;     cast(null as int) as age_group_id,</span></span>
<span><span class="co">#&gt; cast(null as int) as gender_id,</span></span>
<span><span class="co">#&gt; cast(null as int) as start_year,</span></span>
<span><span class="co">#&gt;     SUM(CAST((DATEDIFF(day,t1.start_date,t1.end_date) + 1) as bigint)) as person_days_pe,</span></span>
<span><span class="co">#&gt;     COUNT(distinct t1.subject_id) as persons_at_risk_pe</span></span>
<span><span class="co">#&gt;   FROM tar_overall t1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   GROUP BY t1.target_cohort_definition_id, t1.tar_id, t1.subgroup_id</span></span>
<span><span class="co">#&gt; ) T_OVERALL</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; WITH outcomes_overall (target_cohort_definition_id, tar_id, subgroup_id, outcome_id, subject_id, age, gender_id, start_year, excluded_days, tar_days, outcomes_pe, outcomes)</span></span>
<span><span class="co">#&gt;  AS (</span></span>
<span><span class="co">#&gt;   SELECT </span></span>
<span><span class="co">#&gt;     t1.cohort_definition_id as target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;     t1.tar_id,</span></span>
<span><span class="co">#&gt;     t1.subgroup_id,</span></span>
<span><span class="co">#&gt;     op.outcome_id,</span></span>
<span><span class="co">#&gt;     t1.subject_id,</span></span>
<span><span class="co">#&gt;     YEAR(t1.start_date) - p.year_of_birth as age,</span></span>
<span><span class="co">#&gt;     p.gender_concept_id as gender_id,</span></span>
<span><span class="co">#&gt;     YEAR(t1.start_date) as start_year,</span></span>
<span><span class="co">#&gt;     coalesce(e1.person_days, 0) as excluded_days,</span></span>
<span><span class="co">#&gt;     DATEDIFF(day,t1.start_date,t1.end_date) + 1 as tar_days,</span></span>
<span><span class="co">#&gt;     coalesce(o1.outcomes_pe, 0) as outcomes_pe,</span></span>
<span><span class="co">#&gt;     coalesce(o1.outcomes, 0) as outcomes</span></span>
<span><span class="co">#&gt;   FROM #TTAR_erafied t1</span></span>
<span><span class="co">#&gt;   JOIN mycdm.person p ON t1.subject_id = p.person_id</span></span>
<span><span class="co">#&gt;   JOIN ( -- get the list of TTSO of anyone with excluded time or outcomes to limit result</span></span>
<span><span class="co">#&gt;     select target_cohort_definition_id, tar_id, subgroup_id, outcome_id, subject_id, start_date FROM #excluded_person_days</span></span>
<span><span class="co">#&gt;     UNION -- will remove dupes</span></span>
<span><span class="co">#&gt;     select target_cohort_definition_id, tar_id, subgroup_id, outcome_id, subject_id, start_date FROM #outcome_smry</span></span>
<span><span class="co">#&gt;   ) op ON t1.cohort_definition_id = op.target_cohort_definition_id</span></span>
<span><span class="co">#&gt;     AND t1.tar_id = op.tar_id</span></span>
<span><span class="co">#&gt;     AND t1.subgroup_id = op.subgroup_id</span></span>
<span><span class="co">#&gt;     AND t1.subject_id = op.subject_id</span></span>
<span><span class="co">#&gt;     AND t1.start_date = op.start_date</span></span>
<span><span class="co">#&gt;   LEFT JOIN #excluded_person_days e1 ON e1.target_cohort_definition_id = op.target_cohort_definition_id</span></span>
<span><span class="co">#&gt;     AND e1.tar_id = op.tar_id</span></span>
<span><span class="co">#&gt;     AND e1.subgroup_id = op.subgroup_id</span></span>
<span><span class="co">#&gt;     AND e1.outcome_id = op.outcome_id</span></span>
<span><span class="co">#&gt;     AND e1.subject_id = op.subject_id </span></span>
<span><span class="co">#&gt;     AND e1.start_date = op.start_date</span></span>
<span><span class="co">#&gt;   LEFT JOIN #outcome_smry o1 on o1.target_cohort_definition_id = op.target_cohort_definition_id</span></span>
<span><span class="co">#&gt;    AND o1.tar_id = op.tar_id</span></span>
<span><span class="co">#&gt;    AND o1.subgroup_id = op.subgroup_id</span></span>
<span><span class="co">#&gt;    AND o1.outcome_id = op.outcome_id</span></span>
<span><span class="co">#&gt;    AND o1.subject_id = op.subject_id</span></span>
<span><span class="co">#&gt;    AND o1.start_date = op.start_date</span></span>
<span><span class="co">#&gt; )</span></span>
<span><span class="co">#&gt; SELECT target_cohort_definition_id, tar_id, subgroup_id, outcome_id, age_group_id, gender_id, start_year, excluded_days, excluded_persons, person_outcomes_pe, person_outcomes, outcomes_pe, outcomes</span></span>
<span><span class="co">#&gt; INTO #outcome_agg</span></span>
<span><span class="co">#&gt; FROM</span></span>
<span><span class="co">#&gt; (</span></span>
<span><span class="co">#&gt;     SELECT</span></span>
<span><span class="co">#&gt;     t1.target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;     t1.tar_id,</span></span>
<span><span class="co">#&gt;     t1.subgroup_id,</span></span>
<span><span class="co">#&gt;     t1.outcome_id,    </span></span>
<span><span class="co">#&gt;     cast(null as int) as age_group_id,</span></span>
<span><span class="co">#&gt; cast(null as int) as gender_id,</span></span>
<span><span class="co">#&gt; cast(null as int) as start_year,</span></span>
<span><span class="co">#&gt;     SUM(t1.excluded_days) as excluded_days,</span></span>
<span><span class="co">#&gt;     -- excluded persons is number of distinct persons minus distinct persons with tar</span></span>
<span><span class="co">#&gt;     COUNT(distinct t1.subject_id) - COUNT(distinct case when t1.tar_days &gt; t1.excluded_days then t1.subject_id end) as excluded_persons,</span></span>
<span><span class="co">#&gt;     COUNT(distinct case when t1.outcomes_pe &gt; 0 then t1.subject_id end) as person_outcomes_pe,</span></span>
<span><span class="co">#&gt;     COUNT(distinct case when t1.outcomes &gt; 0 then t1.subject_id end) as person_outcomes,</span></span>
<span><span class="co">#&gt;     SUM(t1.outcomes_pe) as outcomes_pe,</span></span>
<span><span class="co">#&gt;     SUM(t1.outcomes) as outcomes</span></span>
<span><span class="co">#&gt;   FROM outcomes_overall t1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   GROUP BY target_cohort_definition_id, tar_id, subgroup_id, outcome_id</span></span>
<span><span class="co">#&gt; ) O_OVERALL</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- 6) Create analysis_ref to produce each T/O/TAR/S combo</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SELECT t1.target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;   tar1.tar_id,</span></span>
<span><span class="co">#&gt;   s1.subgroup_id,</span></span>
<span><span class="co">#&gt;   o1.outcome_id</span></span>
<span><span class="co">#&gt; INTO #tscotar_ref</span></span>
<span><span class="co">#&gt; FROM (SELECT target_cohort_definition_id FROM myresults.target_def WHERE target_cohort_definition_id in (1) and ref_id = 1) t1,</span></span>
<span><span class="co">#&gt;   (SELECT tar_id FROM myresults.tar_def WHERE tar_id in (1) and ref_id = 1) tar1,</span></span>
<span><span class="co">#&gt;   (SELECT subgroup_id FROM myresults.subgroup_def where ref_id = 1) s1,</span></span>
<span><span class="co">#&gt;   (SELECT outcome_id FROM myresults.outcome_def WHERE outcome_id in (1) and ref_id = 1) o1</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- 7) Insert into final table: calculate results via #tar_agg and #outcome_agg for all TSCOTAR combinations</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; INSERT INTO myresults.incidence_summary (ref_id, source_name, target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;   tar_id, subgroup_id, outcome_id, age_group_id, gender_id, gender_name, start_year,</span></span>
<span><span class="co">#&gt;   persons_at_risk_pe, persons_at_risk, person_days_pe, person_days, </span></span>
<span><span class="co">#&gt;   person_outcomes_pe, person_outcomes, outcomes_pe, outcomes,</span></span>
<span><span class="co">#&gt;   incidence_proportion_p100p, incidence_rate_p100py)</span></span>
<span><span class="co">#&gt; SELECT CAST(1 as int) as ref_id, 'mysource' as source_name, tref.target_cohort_definition_id,</span></span>
<span><span class="co">#&gt;   tref.tar_id, tref.subgroup_id, tref.outcome_id, ta.age_group_id, ta.gender_id, c.concept_name as gender_name, ta.start_year,</span></span>
<span><span class="co">#&gt;   coalesce(ta.persons_at_risk_pe, 0) as persons_at_risk_pe, </span></span>
<span><span class="co">#&gt;   coalesce(ta.persons_at_risk_pe, 0) - coalesce(oa.excluded_persons, 0) as persons_at_risk, </span></span>
<span><span class="co">#&gt;   coalesce(ta.person_days_pe, 0) as  person_days_pe,</span></span>
<span><span class="co">#&gt;   coalesce(ta.person_days_pe, 0) - coalesce(oa.excluded_days, 0) as person_days,</span></span>
<span><span class="co">#&gt;   coalesce(oa.person_outcomes_pe, 0) as person_outcomes_pe,</span></span>
<span><span class="co">#&gt;   coalesce(oa.person_outcomes, 0) as person_outcomes, </span></span>
<span><span class="co">#&gt;   coalesce(oa.outcomes_pe, 0) as outcomes_pe,</span></span>
<span><span class="co">#&gt;   coalesce(oa.outcomes, 0) as outcomes,</span></span>
<span><span class="co">#&gt;   case when coalesce(ta.persons_at_risk_pe, 0) - coalesce(oa.excluded_persons, 0) &gt; 0 then </span></span>
<span><span class="co">#&gt;     (100.0 * cast(coalesce(oa.person_outcomes,0) as float) / (cast(coalesce(ta.persons_at_risk_pe, 0) - coalesce(oa.excluded_persons, 0) as float)))</span></span>
<span><span class="co">#&gt;   end as incidence_proportion_p100p, </span></span>
<span><span class="co">#&gt;   case when coalesce(ta.person_days_pe, 0) - coalesce(oa.excluded_days, 0) &gt; 0 then </span></span>
<span><span class="co">#&gt;     (100.0 * cast(coalesce(oa.outcomes,0) as float) / (cast(coalesce(ta.person_days_pe, 0) - coalesce(oa.excluded_days, 0) as float) / 365.25))</span></span>
<span><span class="co">#&gt;   end AS incidence_rate_p100py</span></span>
<span><span class="co">#&gt; FROM #tscotar_ref tref</span></span>
<span><span class="co">#&gt; LEFT JOIN #tar_agg ta ON tref.target_cohort_definition_id = ta.target_cohort_definition_id</span></span>
<span><span class="co">#&gt;   AND tref.tar_id = ta.tar_id</span></span>
<span><span class="co">#&gt;   AND tref.subgroup_id = ta.subgroup_id</span></span>
<span><span class="co">#&gt; LEFT JOIN #outcome_agg oa ON ta.target_cohort_definition_id = oa.target_cohort_definition_id</span></span>
<span><span class="co">#&gt;   AND ta.tar_id = oa.tar_id</span></span>
<span><span class="co">#&gt;   AND ta.subgroup_id = oa.subgroup_id </span></span>
<span><span class="co">#&gt;   AND tref.outcome_id = oa.outcome_id</span></span>
<span><span class="co">#&gt;   AND coalesce(ta.age_group_id,-1) = coalesce(oa.age_group_id,-1)</span></span>
<span><span class="co">#&gt;   AND coalesce(ta.gender_id,-1) = coalesce(oa.gender_id,-1)</span></span>
<span><span class="co">#&gt;   AND coalesce(ta.start_year, -1) = coalesce(oa.start_year,-1)</span></span>
<span><span class="co">#&gt; LEFT JOIN mycdm.concept c on c.concept_id = ta.gender_id</span></span>
<span><span class="co">#&gt; ;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; -- CLEANUP TEMP TABLES</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; DROP TABLE #TTAR_erafied;</span></span>
<span><span class="co">#&gt; DROP TABLE #subgroup_person;</span></span>
<span><span class="co">#&gt; DROP TABLE #excluded_tar_cohort;</span></span>
<span><span class="co">#&gt; DROP TABLE #exc_TTAR_o_erafied;</span></span>
<span><span class="co">#&gt; DROP TABLE #outcome_smry;</span></span>
<span><span class="co">#&gt; DROP TABLE #excluded_person_days;</span></span>
<span><span class="co">#&gt; DROP TABLE #tscotar_ref;</span></span>
<span><span class="co">#&gt; DROP TABLE #tar_agg;</span></span>
<span><span class="co">#&gt; DROP TABLE #outcome_agg;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; --</span></span>
<span><span class="co">#&gt; -- End analysis 0</span></span>
<span><span class="co">#&gt; --</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="render-sql-with-paramaters-and-execute">Render SQL with paramaters and execute<a class="anchor" aria-label="anchor" href="#render-sql-with-paramaters-and-execute"></a>
</h3>
<p>With the previous analysis design and options used to generate the
analysisSql, the next step is to render the SQL to provide any remaining
parameters, translate, and execute on the database:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># if you didn't pass sourceName to buildOptions(), you can render it here</span></span>
<span><span class="va">analysisSql</span> <span class="op">&lt;-</span> <span class="fu">SqlRender</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/render.html" class="external-link">render</a></span><span class="op">(</span><span class="va">analysisSql</span>, <span class="st">"sourceName"</span> <span class="op">=</span> <span class="st">"OptumDOD"</span><span class="op">)</span></span>
<span><span class="va">analysisSql</span> <span class="op">&lt;-</span> <span class="fu">SqlRender</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/SqlRender/reference/translate.html" class="external-link">translate</a></span><span class="op">(</span><span class="va">analysisSql</span>, <span class="st">"postgresql"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="va">analysisSql</span><span class="op">)</span></span>
<span></span>
<span><span class="va">conn</span> <span class="op">&lt;-</span> <span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/connect.html" class="external-link">connect</a></span><span class="op">(</span><span class="va">connectionDetails</span><span class="op">)</span></span>
<span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/executeSql.html" class="external-link">executeSql</a></span><span class="op">(</span><span class="va">conn</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"DELETE FROM myresults.incidence_summary WHERE ref_id = "</span>, <span class="va">buildOptions</span><span class="op">$</span><span class="va">refId</span><span class="op">$</span><span class="fu">intValue</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/executeSql.html" class="external-link">executeSql</a></span><span class="op">(</span><span class="va">conn</span>, <span class="va">analysisSql</span><span class="op">)</span></span>
<span><span class="fu">DatabaseConnector</span><span class="fu">::</span><span class="fu"><a href="https://ohdsi.github.io/DatabaseConnector/reference/disconnect.html" class="external-link">disconnect</a></span><span class="op">(</span><span class="va">conn</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="using-temp-tables">Using Temp Tables<a class="anchor" aria-label="anchor" href="#using-temp-tables"></a>
</h3>
<p>Sometimes, it is not convenient or possible to create dedicated
tables to store the results. Instead, the useTempTables option can be
used to place the incidence results into a temp table
‘incidence_summary’, where they can be ETL’d to another table or
exported to a CSV.</p>
<p>The following example demonstrates the additional steps that are
necessary if you want to use temp tables:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co"># given the prior irDesign constructed from the previous example</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>buildOptions <span class="ot">&lt;-</span> CohortIncidence<span class="sc">::</span><span class="fu">buildOptions</span>(<span class="at">cohortTable =</span> <span class="st">"demoCohortSchema.cohort"</span>,</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>                                              <span class="at">cdmDatabaseSchema =</span> <span class="st">"mycdm"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>                                              <span class="at">sourceName =</span> <span class="st">"mysource"</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>                                              <span class="at">useTempTables =</span> T,</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>                                              <span class="at">refId =</span> <span class="dv">2</span>)</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>analysisSql <span class="ot">&lt;-</span> CohortIncidence<span class="sc">::</span><span class="fu">buildQuery</span>(<span class="at">incidenceDesign =</span> <span class="fu">as.character</span>(jsonlite<span class="sc">::</span><span class="fu">toJSON</span>(irDesign)),</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>                                           <span class="at">buildOptions =</span> buildOptions)</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>analysisSql <span class="ot">&lt;-</span> SqlRender<span class="sc">::</span><span class="fu">translate</span>(analysisSql, <span class="st">"postgresql"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co"># if we are using temp tables, the steps to execute the analysis are </span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="co">#   1) create result temp tables</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="co">#   2) execute the analysis query, placing the results into the temp table incidence_summary</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="co">#   3) Extract/copy the results from the temp tables</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="co">#   4) clean up temp tables</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>conn <span class="ot">&lt;-</span> DatabaseConnector<span class="sc">::</span><span class="fu">connect</span>(connectionDetails)</span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>tempDDL <span class="ot">&lt;-</span> SqlRender<span class="sc">::</span><span class="fu">translate</span>(CohortIncidence<span class="sc">::</span><span class="fu">getResultsDdl</span>(<span class="at">useTempTables=</span>T), <span class="st">"postgresql"</span>)</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>DatabaseConnector<span class="sc">::</span><span class="fu">executeSql</span>(conn, tempDDL)</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>DatabaseConnector<span class="sc">::</span><span class="fu">executeSql</span>(conn, analysisSql)</span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a><span class="co"># In this example, copy to a permanent table from the temp table, but the results could be downloaded to CSV</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>exportSql <span class="ot">&lt;-</span> SqlRender<span class="sc">::</span><span class="fu">translate</span>(<span class="st">"insert into mySchema.prefix_incidence_summary select * from #incidence_summary"</span>, <span class="st">"postgresql"</span>);</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>DatabaseConnector<span class="sc">::</span><span class="fu">executeSql</span>(conn, exportSql)</span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a><span class="co"># or download the results to a dataframe</span></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>results <span class="ot">&lt;-</span> DatabaseConnector<span class="sc">::</span><span class="fu">querySql</span>(conn, SqlRender<span class="sc">::</span><span class="fu">translate</span>(<span class="st">"select * from #incidence_summary"</span>, <span class="st">"postgresql"</span>))</span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="co"># use the getCleanupSql to fetch the DROP TABLE expressions for the tables that were created in tempDDL.</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>cleanupSql <span class="ot">&lt;-</span> SqlRender<span class="sc">::</span><span class="fu">translate</span>(CohortIncidence<span class="sc">::</span><span class="fu">getCleanupSql</span>(<span class="at">useTempTables=</span>T), <span class="st">"postgresql"</span>)  </span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>DatabaseConnector<span class="sc">::</span><span class="fu">executeSql</span>(conn, cleanupSql)</span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>DatabaseConnector<span class="sc">::</span><span class="fu">dbDisconnect</span>(conn)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Christopher Knoll.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
